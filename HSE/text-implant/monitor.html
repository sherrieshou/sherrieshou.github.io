<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Monitor Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f5f5;
        }

        .container {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-left: 24px;
            padding-right: 24px;
            padding-top: 24px;
            padding-bottom: 8px;
        }

        .back-link {
            font-size: 16px;
            color: #666;
            cursor: pointer;
            display: flex;
            align-items: center;
            padding-left: 16px;
            padding-right: 16px;
            gap: 8px;
        }

        .user-info {
            font-size: 14px;
            color: #666;
        }

        .nav-pills {
            display: flex;
            justify-content: center;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .pill {
            padding: 4px 16px;
            border: 2px solid #ccc;
            border-radius: 25px;
            background-color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .arrow {
            color: #ccc;
            font-size: 20px;
            transition: color 0.3s ease;
        }

        .arrow.completed {
            color: #333;
        }

        .timeline-section {
            padding-left:24px;
            padding-right:24px;
            overflow-x: auto;
        }

        .timeline-chart {
            min-width: 100%;
            height: 300px;
            position: relative;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timeline-chart img,
        .timeline-chart video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }

        .content-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 24px;
            min-height: auto;
        }

        .section {
            border: 2px solid #6C6C6C;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .section-header {
            padding-top: 16px;
            font-size: 20px;
            font-weight: 600;
            text-align: center;
            position: relative;
            z-index: 2;
        }

        .camera-section {
            flex: 1;
            position: relative;
        }

        .camera-content {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('camera.png');
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: flex-end;
            padding: 15px;
            gap: 10px;
            z-index: 1;
        }

        .camera-label {
            background-color: white;
            border: 1px solid #6C6C6C;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .auto-mode-section {
            padding-top: 0px;
            padding-left: 8px;
            padding-right: 8px;
            padding-bottom: 8px;
            height: auto;
        }

        .config-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .config-value {
            font-size: 14px;
            font-weight: 500;
           
            border-bottom: 2px solid #6C6C6C;
            margin-bottom: 8px;
        }

        .driver-info {
            margin-bottom: 8px;
        }

        .driver-name {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .driver-detail {
            font-size: 16px;
            color: #666;
            margin-bottom: 4px;
            font-family: 'Courier New', monospace;
            font-weight: 400;
        }

        .status-box {
            border: 2px dashed #6C6C6C;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
            font-size: 13px;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #4ade80;
            border-radius: 50%;
            margin-right: 6px;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            justify-content: space-between;
        }

        .pause-btn {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #4ade80;
            border-radius: 8px;
            background-color: white;
            color: #4ade80;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pause-btn:hover {
            background-color: #f0fdf4;
        }

        .pause-btn.paused {
            border: 2px solid #ef4444;
            color: #ef4444;
        }

        .pause-btn.paused:hover {
            background-color: #fef2f2;
        }

        .pause-btn.resume {
            border: 2px solid #4ade80;
            color: #4ade80;
        }

        .pause-btn.resume:hover {
            background-color: #f0fdf4;
        }

        /* Modal Overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            width: 50vw;
            height: 50vh;
            background-color: white;
            border-radius: 8px;
            padding: 32px;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        .modal-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #333;
            text-align: center;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            margin-top: auto;
        }

        .modal-next-btn {
            padding: 12px 32px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            background-color: #555;
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .modal-next-btn:hover {
            background-color: #333;
        }

        .modal-countdown {
            padding: 12px 32px;
            font-size: 24px;
            font-weight: 600;
            color: #555;
            text-align: center;
        }

        @media (max-width: 1024px) {
            .content-area {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .nav-pills {
                flex-wrap: wrap;
            }

            .header {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="back-link" onclick="window.location.href='configuration.html'">
                ‹ Back
            </div>
            <div class="nav-pills">
                <div class="pill" id="pill-descend">Descend Toward Target</div>
                <div class="arrow" id="arrow-1">></div>
                <div class="pill" id="pill-precise">Precise Electrode Insertion</div>
                <div class="arrow" id="arrow-2">></div>
                <div class="pill" id="pill-release">Release of Electrode</div>
                <div class="arrow" id="arrow-3">></div>
                <div class="pill" id="pill-retract">Retract Inserter</div>
                <div class="arrow" id="arrow-4">></div>
                <div class="pill" id="pill-return">Return to Origin</div>
            </div>
        </div>

      

        <div class="timeline-section">
            <div class="timeline-chart">
                <img src="img/text-signal-fix.png" alt="Timeline Chart">
            </div>
        </div>

        <div class="content-area">
            <div class="section camera-section">
                <div class="section-header">Live Camera</div>
                <div class="camera-content">
                    <div class="camera-label">Mouse name：Rat111</div>
                    <div class="camera-label">Temp: 37.5 °C</div>
                </div>
            </div>

            <div class="section auto-mode-section">
                <div class="section-header">Auto Mode</div>
                <div style="padding: 8px;">
                    <div class="config-label" id="config-name">Configuration: Flexible Implant – Standard</div>
                    <div class="config-value"></div>

                    <div class="driver-info">
                        <div class="driver-name">Primary Driver</div>
                        <div class="driver-detail" id="primary-target">Target Position: n mm</div>
                        <div class="driver-detail" id="primary-position">Current Position: 0.00 mm</div>
                        <div class="driver-detail" id="primary-velocity">Current Velocity: 0.00 mm/s</div>
                    </div>

                    <div class="driver-info">
                        <div class="driver-name">Inserter Driver</div>
                        <div class="driver-detail" id="inserter-target">Target Position: 186.3 mm</div>
                        <div class="driver-detail" id="inserter-position">Current Position: 0.00 mm</div>
                        <div class="driver-detail" id="inserter-velocity">Current Velocity: 0.00 mm/s</div>
                    </div>

                    <div class="status-box">
                        <div><span class="status-indicator"></span><strong>Ready</strong> Configuration is locked while Auto Mode is active</div>
                    </div>

                    <div class="button-group">
                        <button id="pause-btn" class="pause-btn">▶ Start</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="completion-modal">
        <div class="modal">
            <div class="modal-content" id="modal-content-text">
                Primary driver is now at the targeted position
            </div>
            <div class="modal-footer">
                <button class="modal-next-btn" id="modal-next-btn">Next</button>
                <div class="modal-countdown" id="modal-countdown" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // Load configuration data from localStorage
        let configData = null;
        const configDataStr = localStorage.getItem('configurationData');
        if (configDataStr) {
            configData = JSON.parse(configDataStr);
            
            // Update configuration name
            const configNameEl = document.getElementById('config-name');
            if (configNameEl) {
                configNameEl.textContent = 'Configuration: ' + configData.configName;
            }
            
            // Update Primary Driver Target Position
            const primaryTargetEl = document.getElementById('primary-target');
            if (primaryTargetEl && configData.primaryDriver.destination) {
                primaryTargetEl.textContent = 'Target Position: ' + configData.primaryDriver.destination + ' mm';
            }
            
            // Update Inserter Driver Target Position
            const inserterTargetEl = document.getElementById('inserter-target');
            if (inserterTargetEl && configData.inserterDriver.destination) {
                inserterTargetEl.textContent = 'Target Position: ' + configData.inserterDriver.destination + ' mm';
            }
        }

        // Animation controller to manage pause/resume
        const animationController = {
            animations: [],
            isPaused: false,
            completedCount: 0,
            totalAnimations: 0,
            phase: 'primary', // 'primary' or 'inserter'
            
            pause: function() {
                this.isPaused = true;
                this.animations.forEach(anim => {
                    if (anim.animationId) {
                        cancelAnimationFrame(anim.animationId);
                        anim.animationId = null;
                    }
                });
            },
            
            resume: function() {
                this.isPaused = false;
                this.animations.forEach(anim => {
                    if (anim.progress < 1) {
                        anim.startTime = performance.now() - (anim.progress * anim.duration);
                        anim.animationId = requestAnimationFrame(anim.update.bind(anim));
                    }
                });
            },
            
            addAnimation: function(anim) {
                this.animations.push(anim);
                this.totalAnimations++;
            },
            
            onAnimationComplete: function(animType) {
                this.completedCount++;
                
                if (this.phase === 'primary' && this.completedCount === this.totalAnimations) {
                    // Primary phase animations completed, automatically start inserter phase
                    // Set primary-velocity to 0.00 mm/s
                    const primaryVelocityEl = document.getElementById('primary-velocity');
                    if (primaryVelocityEl) {
                        primaryVelocityEl.textContent = 'Current Velocity: 0.00 mm/s';
                    }
                    
                    // Make Descend Toward Target pill permanently dark
                    const descendPill = document.getElementById('pill-descend');
                    if (descendPill) {
                        descendPill.classList.add('completed');
                    }
                    // Make first arrow dark
                    const arrow1 = document.getElementById('arrow-1');
                    if (arrow1) {
                        arrow1.classList.add('completed');
                    }
                    
                    // Replace image with video in timeline-chart
                    const timelineChart = document.querySelector('.timeline-chart');
                    if (timelineChart) {
                        const img = timelineChart.querySelector('img');
                        if (img) {
                            const video = document.createElement('video');
                            video.src = 'text-signal.mp4';
                            video.loop = true;
                            video.autoplay = true;
                            video.muted = true; // Required for autoplay in most browsers
                            video.playsInline = true; // For mobile devices
                            img.replaceWith(video);
                        }
                    }
                    
                    // Wait 5 seconds before starting the second animation
                    setTimeout(function() {
                        // Start Inserter Driver animations automatically
                        if (configData) {
                            // Reset animation controller for new animations (inserter phase)
                            animationController.reset('inserter');
                            
                            // Get current Inserter Driver position (should be at Primary Driver target position)
                            const inserterPositionEl = document.getElementById('inserter-position');
                            const currentPositionText = inserterPositionEl ? inserterPositionEl.textContent : 'Current Position: 0.00 mm';
                            const currentPosition = parseFloat(currentPositionText.match(/[\d.]+/)?.[0] || '0');
                            
                            // Animate Inserter Driver Current Position to Inserter Driver Target Position
                            const inserterTargetPosition = parseFloat(configData.inserterDriver.destination);
                            if (inserterPositionEl && inserterTargetPosition) {
                                animateNumber(
                                    inserterPositionEl,
                                    'Current Position: ',
                                    ' mm',
                                    currentPosition,
                                    inserterTargetPosition,
                                    10000,
                                    'inserter-position'
                                );
                            }
                            
                            // Animate Inserter Driver Current Velocity to Inserter Driver Velocity
                            const inserterVelocityEl = document.getElementById('inserter-velocity');
                            const inserterTargetVelocity = parseFloat(configData.inserterDriver.velocity);
                            if (inserterVelocityEl && inserterTargetVelocity) {
                                animateNumber(
                                    inserterVelocityEl,
                                    'Current Velocity: ',
                                    ' mm/s',
                                    0.00,
                                    inserterTargetVelocity,
                                    5000,
                                    'inserter-velocity'
                                );
                            }
                        }
                    }, 5000); // 5 second delay
                } else if (this.phase === 'inserter' && animType === 'inserter-position') {
                    // Inserter Driver position animation completed, set inserter-velocity to 0.00 mm/s
                    const inserterVelocityEl = document.getElementById('inserter-velocity');
                    if (inserterVelocityEl) {
                        inserterVelocityEl.textContent = 'Current Velocity: 0.00 mm/s';
                    }
                    
                    // Show second modal with countdown
                    const modal = document.getElementById('completion-modal');
                    const modalContent = document.getElementById('modal-content-text');
                    const modalNextBtn = document.getElementById('modal-next-btn');
                    const modalCountdown = document.getElementById('modal-countdown');
                    if (modal && modalContent) {
                        modalContent.innerHTML = 'Inserter driver is now at the targeted position, now please gently unscrew the flexible electrode (the small square block) to release it from the holder.';
                        // Hide button, show countdown
                        if (modalNextBtn) {
                            modalNextBtn.style.display = 'none';
                        }
                        if (modalCountdown) {
                            modalCountdown.style.display = 'block';
                        }
                        modal.classList.add('show');
                        
                        // Start 15 second countdown
                        let countdown = 15;
                        const updateCountdown = () => {
                            if (modalCountdown) {
                                modalCountdown.textContent = countdown;
                            }
                            if (countdown > 0) {
                                countdown--;
                                setTimeout(updateCountdown, 1000);
                            } else {
                                // Countdown finished, close modal and start retract animation
                                modal.classList.remove('show');
                                if (modalNextBtn) {
                                    modalNextBtn.style.display = 'block';
                                }
                                if (modalCountdown) {
                                    modalCountdown.style.display = 'none';
                                }
                                
                                // Start retract animation
                                // Make Release of Electrode pill permanently dark
                                const releasePill = document.getElementById('pill-release');
                                if (releasePill) {
                                    releasePill.classList.add('completed');
                                }
                                // Make third arrow dark
                                const arrow3 = document.getElementById('arrow-3');
                                if (arrow3) {
                                    arrow3.classList.add('completed');
                                }
                                
                                if (configData) {
                                    // Reset animation controller for retract phase
                                    animationController.reset('retract');
                                    
                                    // Get current Inserter Driver position (should be at Inserter Driver target position)
                                    const inserterPositionEl = document.getElementById('inserter-position');
                                    const currentPositionText = inserterPositionEl ? inserterPositionEl.textContent : 'Current Position: 0.00 mm';
                                    const currentPosition = parseFloat(currentPositionText.match(/[\d.]+/)?.[0] || '0');
                                    
                                    // Animate Inserter Driver Current Position back to Primary Driver Destination
                                    const primaryTargetPosition = parseFloat(configData.primaryDriver.destination);
                                    if (inserterPositionEl && primaryTargetPosition) {
                                        animateNumber(
                                            inserterPositionEl,
                                            'Current Position: ',
                                            ' mm',
                                            currentPosition,
                                            primaryTargetPosition,
                                            30000,
                                            'inserter-retract'
                                        );
                                    }
                                    
                                    // Animate Inserter Driver Current Velocity to preset value
                                    const inserterVelocityEl = document.getElementById('inserter-velocity');
                                    const inserterTargetVelocity = parseFloat(configData.inserterDriver.velocity);
                                    if (inserterVelocityEl && inserterTargetVelocity) {
                                        animateNumber(
                                            inserterVelocityEl,
                                            'Current Velocity: ',
                                            ' mm/s',
                                            0.00,
                                            inserterTargetVelocity,
                                            5000,
                                            'inserter-velocity-retract'
                                        );
                                    }
                                }
                            }
                        };
                        updateCountdown();
                    }
                    // Make Precise Electrode Insertion pill permanently dark
                    const precisePill = document.getElementById('pill-precise');
                    if (precisePill) {
                        precisePill.classList.add('completed');
                    }
                    // Make second arrow dark
                    const arrow2 = document.getElementById('arrow-2');
                    if (arrow2) {
                        arrow2.classList.add('completed');
                    }
                } else if (this.phase === 'retract' && animType === 'inserter-retract') {
                    // Inserter Driver retract animation completed, automatically start return phase
                    // Make Retract Inserter pill permanently dark
                    const retractPill = document.getElementById('pill-retract');
                    if (retractPill) {
                        retractPill.classList.add('completed');
                    }
                    // Make fourth arrow dark
                    const arrow4 = document.getElementById('arrow-4');
                    if (arrow4) {
                        arrow4.classList.add('completed');
                    }
                    
                    // Start return animations automatically
                    if (configData) {
                        // Reset animation controller for return phase
                        animationController.reset('return');
                        
                        // Set inserter-velocity to 0.00 mm/s at the start of return phase
                        const inserterVelocityEl = document.getElementById('inserter-velocity');
                        if (inserterVelocityEl) {
                            inserterVelocityEl.textContent = 'Current Velocity: 0.00 mm/s';
                        }
                        
                        // Get current positions
                        const primaryPositionEl = document.getElementById('primary-position');
                        const inserterPositionEl = document.getElementById('inserter-position');
                        const primaryVelocityEl = document.getElementById('primary-velocity');
                        
                        const primaryCurrentPositionText = primaryPositionEl ? primaryPositionEl.textContent : 'Current Position: 0.00 mm';
                        const inserterCurrentPositionText = inserterPositionEl ? inserterPositionEl.textContent : 'Current Position: 0.00 mm';
                        const primaryCurrentPosition = parseFloat(primaryCurrentPositionText.match(/[\d.]+/)?.[0] || '0');
                        const inserterCurrentPosition = parseFloat(inserterCurrentPositionText.match(/[\d.]+/)?.[0] || '0');
                        
                        // Animate Primary Driver Current Position back to 0.00
                        if (primaryPositionEl) {
                            animateNumber(
                                primaryPositionEl,
                                'Current Position: ',
                                ' mm',
                                primaryCurrentPosition,
                                0.00,
                                30000,
                                'primary-position-return'
                            );
                        }
                        
                        // Animate Inserter Driver Current Position back to 0.00
                        if (inserterPositionEl) {
                            animateNumber(
                                inserterPositionEl,
                                'Current Position: ',
                                ' mm',
                                inserterCurrentPosition,
                                0.00,
                                30000,
                                'inserter-position-return'
                            );
                        }
                        
                        // Animate Primary Driver Current Velocity to preset value
                        const primaryTargetVelocity = parseFloat(configData.primaryDriver.velocity);
                        if (primaryVelocityEl && primaryTargetVelocity) {
                            // Get current velocity value
                            const currentVelocityText = primaryVelocityEl.textContent;
                            const currentVelocity = parseFloat(currentVelocityText.match(/[\d.]+/)?.[0] || '0');
                            
                            animateNumber(
                                primaryVelocityEl,
                                'Current Velocity: ',
                                ' mm/s',
                                currentVelocity,
                                primaryTargetVelocity,
                                5000,
                                'primary-velocity-return'
                            );
                        }
                        
                        // Inserter Driver Current Velocity remains 0.00 (no animation needed)
                    }
                } else if (this.phase === 'return' && (animType === 'primary-position-return' || animType === 'inserter-position-return')) {
                    // Check if both position animations are completed
                    const primaryPosAnim = this.animations.find(a => a.animType === 'primary-position-return');
                    const inserterPosAnim = this.animations.find(a => a.animType === 'inserter-position-return');
                    
                    if (primaryPosAnim && primaryPosAnim.completed && inserterPosAnim && inserterPosAnim.completed) {
                        // Both position animations completed, show fourth modal
                        const modal = document.getElementById('completion-modal');
                        const modalContent = document.getElementById('modal-content-text');
                        const modalNextBtn = document.getElementById('modal-next-btn');
                        const modalCountdown = document.getElementById('modal-countdown');
                        if (modal && modalContent && modalNextBtn) {
                            modalContent.textContent = 'Experiment Completed!';
                            modalNextBtn.textContent = 'Back to Home';
                            // Ensure button is visible and countdown is hidden for other modals
                            if (modalNextBtn) {
                                modalNextBtn.style.display = 'block';
                            }
                            if (modalCountdown) {
                                modalCountdown.style.display = 'none';
                            }
                            modal.classList.add('show');
                        }
                        // Make Return to Origin pill permanently dark
                        const returnPill = document.getElementById('pill-return');
                        if (returnPill) {
                            returnPill.classList.add('completed');
                        }
                    }
                }
            },
            
            reset: function(phase) {
                this.completedCount = 0;
                this.totalAnimations = 0;
                this.animations = [];
                if (phase) {
                    this.phase = phase;
                }
            }
        };

        // Function to animate number from start to end over duration with pause/resume support
        function animateNumber(element, prefix, suffix, startValue, endValue, duration, animType) {
            const difference = endValue - startValue;
            let startTime = performance.now();
            let progress = 0;
            let animationId = null;
            
            const anim = {
                element: element,
                prefix: prefix,
                suffix: suffix,
                startValue: startValue,
                endValue: endValue,
                difference: difference,
                duration: duration,
                startTime: startTime,
                progress: 0,
                animationId: null,
                completed: false,
                animType: animType || null,
                
                update: function(currentTime) {
                    if (animationController.isPaused) {
                        return;
                    }
                    
                    const elapsed = currentTime - this.startTime;
                    this.progress = Math.min(elapsed / this.duration, 1);
                    
                    // Easing function for smooth animation
                    const easeProgress = this.progress < 0.5 
                        ? 2 * this.progress * this.progress 
                        : 1 - Math.pow(-2 * this.progress + 2, 2) / 2;
                    
                    const currentValue = this.startValue + (this.difference * easeProgress);
                    const formattedValue = currentValue.toFixed(2);
                    
                    this.element.textContent = this.prefix + formattedValue + this.suffix;
                    
                    if (this.progress < 1) {
                        this.animationId = requestAnimationFrame(this.update.bind(this));
                    } else {
                        // Ensure final value is exact
                        this.element.textContent = this.prefix + this.endValue.toFixed(2) + this.suffix;
                        this.animationId = null;
                        this.completed = true;
                        animationController.onAnimationComplete(this.animType);
                    }
                }
            };
            
            animationController.addAnimation(anim);
            anim.animationId = requestAnimationFrame(anim.update.bind(anim));
        }

        const pauseBtn = document.getElementById('pause-btn');
        let buttonState = 'start'; // 'start', 'pause', 'resume'
        window.buttonState = buttonState; // Make it accessible globally

        pauseBtn.addEventListener('click', function() {
            if (buttonState === 'start') {
                // Start button clicked - begin animation
                this.textContent = '⏸ Pause';
                this.classList.add('paused');
                this.classList.remove('resume');
                buttonState = 'pause';
                window.buttonState = buttonState;
                
                // Reset animation controller
                animationController.reset();
                
                if (configData) {
                    // Animate Primary Driver Current Velocity
                    const primaryVelocityEl = document.getElementById('primary-velocity');
                    if (primaryVelocityEl && configData.primaryDriver.velocity) {
                        const targetVelocity = parseFloat(configData.primaryDriver.velocity);
                        animateNumber(
                            primaryVelocityEl,
                            'Current Velocity: ',
                            ' mm/s',
                            0.00,
                            targetVelocity,
                            5000,
                            'primary-velocity'
                        );
                    }
                    // Inserter Driver Current Velocity remains 0.00
                    
                    // Animate both Current Positions to Primary Driver Target Position
                    const primaryTargetPosition = parseFloat(configData.primaryDriver.destination);
                    if (primaryTargetPosition) {
                        // Animate Primary Driver Current Position
                        const primaryPositionEl = document.getElementById('primary-position');
                        if (primaryPositionEl) {
                            animateNumber(
                                primaryPositionEl,
                                'Current Position: ',
                                ' mm',
                                0.00,
                                primaryTargetPosition,
                                30000,
                                'primary-position'
                            );
                        }
                        
                        // Animate Inserter Driver Current Position
                        const inserterPositionEl = document.getElementById('inserter-position');
                        if (inserterPositionEl) {
                            animateNumber(
                                inserterPositionEl,
                                'Current Position: ',
                                ' mm',
                                0.00,
                                primaryTargetPosition,
                                30000,
                                'inserter-position-primary'
                            );
                        }
                    }
                }
            } else if (buttonState === 'pause') {
                // Pause button clicked - pause all animations
                animationController.pause();
                this.textContent = '▶ Resume';
                this.classList.remove('paused');
                this.classList.add('resume');
                buttonState = 'resume';
            } else if (buttonState === 'resume') {
                // Resume button clicked - resume all animations
                animationController.resume();
                this.textContent = '⏸ Pause';
                this.classList.remove('resume');
                this.classList.add('paused');
                buttonState = 'pause';
                window.buttonState = buttonState;
            }
        });

        // Handle modal Next button click
        const modalNextBtn = document.getElementById('modal-next-btn');
        if (modalNextBtn) {
            modalNextBtn.addEventListener('click', function() {
                const modalContent = document.getElementById('modal-content-text');
                const currentModalText = modalContent ? modalContent.textContent : '';
                
                // Hide modal
                const modal = document.getElementById('completion-modal');
                const modalCountdown = document.getElementById('modal-countdown');
                if (modal) {
                    modal.classList.remove('show');
                }
                // Ensure button is visible and countdown is hidden when modal is closed
                if (modalNextBtn) {
                    modalNextBtn.style.display = 'block';
                }
                if (modalCountdown) {
                    modalCountdown.style.display = 'none';
                }
                
                // Change resume button back to red pause
                if (pauseBtn) {
                    pauseBtn.textContent = '⏸ Pause';
                    pauseBtn.classList.remove('resume');
                    pauseBtn.classList.add('paused');
                    buttonState = 'pause';
                    window.buttonState = buttonState;
                }
                
                // Check which modal was clicked
                // Note: The "Inserter driver is now at the targeted position" modal now uses countdown and auto-starts
                if (currentModalText.includes('Experiment Completed!')) {
                    // Fourth modal - Navigate to assembly.html
                    window.location.href = 'assembly.html';
                }
            });
        }
    </script>
</body>
</html>